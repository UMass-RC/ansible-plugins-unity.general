todos_fixmes:
  image: alpine
  script:
    - apk add ripgrep curl
    - todo_count="$(rg TODO . | wc -l)"
    - fixme_count="$(rg FIXME . | wc -l)"
    - curl "https://shields.io/badge/TODOs-$todo_count-blue" > todos.svg
    - curl "https://shields.io/badge/FIXMEs-$fixme_count-red" > fixmes.svg
  artifacts:
    paths:
      - todos.svg
      - fixmes.svg
    expire_in: 1 week
ansible_test_integration:
  image: python:3.12-alpine
  script:
    - apk add git openssh-keygen bash uv
    - uv pip install --system -r requirements.txt
    - old_path="$PWD"
    - tmpdir="$(mktemp -d)"
    - trap "rm -rf '$tmpdir'" EXIT
    - mkdir -p "$tmpdir/ansible_collections/unity"
    - mv "$old_path" "$tmpdir/ansible_collections/unity/general"
    - cd "$tmpdir/ansible_collections/unity/general"
    - ansible-galaxy collection install ansible.posix community.general
    - for target_path in tests/integration/targets/*; do
    -     target="$(basename "$target_path")"
    -     if [ "$target" == "callback" ]; then
    -         continue
    -     fi
    -     ansible-test integration --color --diff "$target"
    - done
documentation:
  image: python:3.12-alpine
  script:
    - apk add git openssh-keygen bash uv jq
    - uv pip install --system -r requirements.txt
    - old_path="$PWD"
    - tmpdir="$(mktemp -d)"
    - trap "rm -rf '$tmpdir'" EXIT
    - mkdir -p "$tmpdir/ansible_collections/unity"
    - mv "$old_path" "$tmpdir/ansible_collections/unity/general"
    - cd "$tmpdir"
    - ansible-doc --metadata-dump unity.general 2>/dev/null | jq '.all | with_entries(select(.key != "keyword" and (.value | keys | length) > 0) | .value |= keys)' | jq -r 'to_entries[] | .key as $type | .value[] | . as $plugin | "PAGER=cat ansible-doc -t \($type) \($plugin)"' | bash
