---
####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# FIXME these results assume clustershell is present

- block:
    - name: tempdir
      tempfile:
        state: directory
      register: tempdir
      no_log: true

    - name: run test playbooks
      include_role:
        name: callback
      vars:
        tests:
          - name: basic diff
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: create file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar

                  - name: overwrite file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar
                        Bar baz bam!
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [create file] *************************************************************
              --- before
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -0,0 +1 @@
              +Foo bar
              changed: testhost
              elapsed: <omitted> seconds

              TASK [overwrite file] **********************************************************
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1 +1,2 @@
               Foo bar
              +Bar baz bam!
              changed: testhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=2    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: formatted diff
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
              DIFF_FORMATTER: sed -E 's/Foo/REPLACED/g'
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: create file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar

                  - name: overwrite file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar
                        Bar baz bam!
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [create file] *************************************************************
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1,2 +1 @@
               REPLACED bar
              -Bar baz bam!
              changed: testhost
              elapsed: <omitted> seconds

              TASK [overwrite file] **********************************************************
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1 +1,2 @@
               REPLACED bar
              +Bar baz bam!
              changed: testhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=2    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: diff formatter not found
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
              DIFF_FORMATTER: asdlkjasdlkjs
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: create file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar

                  - name: overwrite file
                    copy:
                      dest: "{{ tempdir.path }}/<redacted hostname>"
                      content: |
                        Foo bar
                        Bar baz bam!
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [create file] *************************************************************
              [WARNING]: diff formatter "asdlkjasdlkjs" not found
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1,2 +1 @@
               Foo bar
              -Bar baz bam!
              changed: testhost
              elapsed: <omitted> seconds

              TASK [overwrite file] **********************************************************
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1 +1,2 @@
               Foo bar
              +Bar baz bam!
              changed: testhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=2    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: empty diff
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: localhost
                gather_facts: false
                tasks:
                  - name: changed true
                    unity.general.return_args:
                      changed: true
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [localhost] ***************************************************************

              TASK [changed true] ************************************************************
              task reports changed=true but does not report any diff.
              changed: localhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: dedupe diff
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: overwrite file (ignore)
                    copy:
                      dest: "{{ tempdir.path }}/{% raw %}{{ inventory_hostname }}{% endraw %}"
                      content: |
                        Foo bar
                        Bar baz bam!
                    diff: false
                    changed_when: false
                  - name: overwrite file
                    copy:
                      dest: "{{ tempdir.path }}/{% raw %}{{ inventory_hostname }}{% endraw %}"
                      content: "{{ '{{ dedupe_me }}' }}"
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [dedupegroup] *************************************************************

              TASK [overwrite file (ignore)] *************************************************
              ok: dedupe[1-3]
              elapsed: <omitted> seconds

              TASK [overwrite file] **********************************************************
              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1,2 +1 @@
              -Foo bar
              -Bar baz bam!
              +bar
              \ No newline at end of file
              changed: dedupe3

              --- before: {{ tempdir.path }}/<redacted hostname>
              +++ after: {{ tempdir.path }}/<redacted hostname>
              @@ -1,2 +1 @@
              -Foo bar
              -Bar baz bam!
              +foo
              \ No newline at end of file
              changed: dedupe[1-2]
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              dedupe1                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe3                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: dedupe normal loop
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            allow_nonzero_exit_code: true
            # I do sha1 because dedupe removes the item from the result and counts them as duplicates
            # I do `!unsafe` because ansible wants to expand j2 templating when the `callback` role iterates over
            # `tests`, and then I think it tries to expand it a second time, which is why I can still use
            # the `{[ '{{ foo }}' }}` trick above but not here
            playbook: !unsafe |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug:
                        msg: "{{ item | sha1 }}"
                    loop:
                      - foo
                      - foo
                      - bar
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost (item=foo) =>
                msg: {{ 'foo' | sha1 }}
              ok: testhost (item=foo) => same result (not including diff) as testhost (item=foo)
              ok: testhost (item=bar) =>
                msg: {{ 'bar' | sha1 }}
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          # once upon a time I relied on the size of the loop variable to determine the number of runners that would be spawned
          # this was a bad idea because the loop variable might just be an un-expanded j2 template string
          - name: dedupe normal loop over a variable
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            allow_nonzero_exit_code: true
            # I do sha1 because dedupe removes the item from the result and counts them as duplicates
            # I do `!unsafe` because ansible wants to expand j2 templating when the `callback` role iterates over
            # `tests`, and then I think it tries to expand it a second time, which is why I can still use
            # the `{[ '{{ foo }}' }}` trick above but not here
            playbook: !unsafe |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - set_fact:
                      loopvar:
                        - foo
                        - foo
                        - bar
                  - name: foo
                    debug:
                        msg: "{{ item | sha1 }}"
                    loop: "{{ loopvar }}"
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [set_fact] ****************************************************************
              ok: testhost
              elapsed: <omitted> seconds

              TASK [foo] *********************************************************************
              ok: testhost (item=foo) =>
                msg: {{ 'foo' | sha1 }}
              ok: testhost (item=foo) => same result (not including diff) as testhost (item=foo)
              ok: testhost (item=bar) =>
                msg: {{ 'bar' | sha1 }}
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: non verbose OK result
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            allow_nonzero_exit_code: true
            playbook: |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: noop
                    ansible.builtin.assert: { that: true, quiet: true }
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [dedupegroup] *************************************************************

              TASK [noop] ********************************************************************
              ok: dedupe[1-3] => All assertions passed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              dedupe1                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe2                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe3                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: dedupe hostname, item label, and `dedupe_me` variable in failed results
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
              ANSIBLE_FORKS: 1
            allow_nonzero_exit_code: true
            playbook: !unsafe |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: fail
                    fail:
                      msg: "host={{ inventory_hostname }} item_label={{ (item | sha1) }} dedupe_me={{ dedupe_me }}"
                    loop: ['aaaaaa', 'bbbbbb']
                    loop_control:
                      label: "{{ (item | sha1) }}"
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [dedupegroup] *************************************************************

              TASK [fail] ********************************************************************
              failed: dedupe1 (item={{ ('aaaaaa' | sha1) }}) =>
                ansible_loop_var: item
                changed: false
                item: aaaaaa
                msg: host=<redacted hostname> item_label=<redacted item> dedupe_me=foo
              failed: dedupe1 (item={{ 'bbbbbb' | sha1 }}) => same result (not including diff) as dedupe1 (item={{ 'aaaaaa' | sha1 }})
              failed: dedupe1 =>
                changed: false
                msg: One or more items failed
              failed: dedupe2 (item={{ 'aaaaaa' | sha1 }}) => same result (not including diff) as dedupe1 (item={{ 'aaaaaa' | sha1 }})
              failed: dedupe2 (item={{ 'bbbbbb' | sha1 }}) => same result (not including diff) as dedupe1 (item={{ 'aaaaaa' | sha1 }})
              failed: dedupe2 => same result (not including diff) as dedupe1
              failed: dedupe3 (item={{ 'aaaaaa' | sha1 }}) =>
                ansible_loop_var: item
                changed: false
                item: aaaaaa
                msg: host=<redacted hostname> item_label=<redacted item> dedupe_me=bar
              failed: dedupe3 (item={{ 'bbbbbb' | sha1 }}) => same result (not including diff) as dedupe3 (item={{ 'aaaaaa' | sha1 }})
              failed: dedupe3 => same result (not including diff) as dedupe1
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              dedupe1                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
              dedupe2                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
              dedupe3                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

          - name: multiple plays
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            allow_nonzero_exit_code: true
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: bar
                    debug: msg='bar'
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost =>
                msg: foo
              elapsed: <omitted> seconds

              PLAY [testhost] ****************************************************************

              TASK [bar] *********************************************************************
              ok: testhost =>
                msg: bar
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: skipped (no hosts matched) on 1st play
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: emptygroup
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: bar
                    debug: msg='bar'
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [emptygroup] **************************************************************
              skipping: no hosts matched

              PLAY [testhost] ****************************************************************

              TASK [bar] *********************************************************************
              ok: testhost =>
                msg: bar
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: skipped (no hosts matched) on 2nd play
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
              - hosts: emptygroup
                gather_facts: false
                tasks:
                  - name: bar
                    debug: msg='bar'
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost =>
                msg: foo
              elapsed: <omitted> seconds

              PLAY [emptygroup] **************************************************************
              skipping: no hosts matched

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

          - name: skipped (when=false) 1st task
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                    when: false
                  - name: bar
                    debug: msg='bar'
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              skipped: testhost => {"skip_reason": "Conditional result was False", "false_condition": false}
              elapsed: <omitted> seconds

              TASK [bar] *********************************************************************
              ok: testhost =>
                msg: bar
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

          - name: skipped (when=false) 2nd task
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                  - name: bar
                    debug: msg='bar'
                    when: false
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost =>
                msg: foo
              elapsed: <omitted> seconds

              TASK [bar] *********************************************************************
              skipped: testhost => {"skip_reason": "Conditional result was False", "false_condition": false}
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

          # sleep_seconds is defined for each host in targets/callback/inventory.yml
          # I used to use timeout=3 but I saw a `sleep 1` marked as interrupted so I increased to timeout=4
          - name: interrupted
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: !unsafe |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: sleep
                    command:
                      cmd: "sleep {{ sleep_seconds }}"
                    changed_when: false
            timeout: 4
            allow_nonzero_exit_code: true
            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
            expected_output: |

              PLAY [dedupegroup] *************************************************************

              TASK [sleep] *******************************************************************
              ok: dedupe[1-2]
              interrupted: dedupe3
              elapsed: <omitted> seconds
               [ERROR]: User interrupted execution

          - name: fatal no hosts matched
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            allow_nonzero_exit_code: true
            playbook: |
              - hosts: nonexistent
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
            expected_output: |
              ERROR! Could not match supplied host pattern, ignoring: nonexistent

          - name: start-at-task nonexistent
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            extra_args: --start-at-task=nonexistent
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                  - name: bar
                    debug: msg='bar'
            expected_output: |+

              PLAY [testhost] ****************************************************************

              PLAY RECAP *********************************************************************



            sed_E_command: |
              s/\[ERROR\]: No matching task "nonexistent" found. Note: --start-at-task can only//;
              s/follow static includes.//

          - name: msg has diacritics
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      msg: "ÅÑŚÌβŁÈ"
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost => ÅÑŚÌβŁÈ
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: msg is empty string
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      msg: ""
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: msg is null
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      msg: null
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: msg is large
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      msg: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost => Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: item has diacritics
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg=''
                    loop: ['ÅÑŚÌβŁÈ']
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost (item=ÅÑŚÌβŁÈ) =>
                msg: ''
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: item is empty string
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                    loop: ['']
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost =>
                msg: foo
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: item is null
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                    loop: [null]
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost =>
                msg: foo
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: item is large
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    debug: msg='foo'
                    loop:
                      - "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."

            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              ok: testhost (item=Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.) =>
                msg: foo
              ok: testhost => All items completed
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: dedupe result exceptions
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
            playbook: |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      changed: false
                      failed: false
                      msg: foo
                      exception: "{{ '{{ dedupe_me }}' }}"

            expected_output: |+

              PLAY [dedupegroup] *************************************************************

              TASK [foo] *********************************************************************
              An exception occurred during task execution. To see the full traceback, use -vvv. The error was: dedupe1: foo
              An exception occurred during task execution. To see the full traceback, use -vvv. The error was: dedupe2: same exception as dedupe1
              An exception occurred during task execution. To see the full traceback, use -vvv. The error was: dedupe3: bar
              ok: dedupe[1-3] => foo
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              dedupe1                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe2                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe3                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: result has deprecations
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
              ANSIBLE_DEPRECATION_WARNINGS: "true"
            playbook: |
              - hosts: testhost
                gather_facts: false
                tasks:
                  - name: foo
                    unity.general.return_args:
                      changed: false
                      failed: false
                      msg: I have deprecations!
                      deprecations:
                        - msg: {{ 'foo' | sha1 }}
                          version: 1.2.3
                          removed: false
                          date: 1970/1/1
                          collection_name: unity.general
                        - msg: {{ 'foo' | sha1 }}
                          version: 1.2.3
                          removed: false
                          date: 1970/1/1
                          collection_name: unity.general
                        - msg: {{ 'bar' | sha1 }}
                          version: 4.5.6
                          removed: false
                          date: 1970/1/2
                          collection_name: unity.general
            expected_output: |+

              PLAY [testhost] ****************************************************************

              TASK [foo] *********************************************************************
              [DEPRECATION WARNING]: testhost[0]: {{ 'foo' | sha1 }}.
              This feature will be removed from unity.general in a release after 1970/1/1.
              Deprecation warnings can be disabled by setting deprecation_warnings=False in
              ansible.cfg.
              [DEPRECATION WARNING]: testhost[2]: {{ 'bar' | sha1 }}.
              This feature will be removed from unity.general in a release after 1970/1/2.
              Deprecation warnings can be disabled by setting deprecation_warnings=False in
              ansible.cfg.
              [DEPRECATION WARNING]: testhost[1]: same deprecation as testhost[0]
              ok: testhost => I have deprecations!
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              testhost                   : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'

          - name: delegate_to
            environment:
              ANSIBLE_FORCE_COLOR: "false"
              ANSIBLE_DIFF_ALWAYS: "true"
              ANSIBLE_PYTHON_INTERPRETER: "{{ ansible_python_interpreter }}"
              ANSIBLE_STDOUT_CALLBACK: unity.general.deduped_default
              ANSIBLE_DEPRECATION_WARNINGS: "true"
            playbook: |
              - hosts: dedupegroup
                gather_facts: false
                tasks:
                  - name: foo
                    debug:
                      msg: foo
                    delegate_to: localhost
            expected_output: |+

              PLAY [dedupegroup] *************************************************************

              TASK [foo] *********************************************************************
              ok: dedupe1 -> localhost =>
                msg: foo
              ok: dedupe2 -> localhost => same result (not including diff) as dedupe1 -> localhost
              ok: dedupe3 -> localhost => same result (not including diff) as dedupe1 -> localhost
              elapsed: <omitted> seconds

              PLAY RECAP *********************************************************************
              dedupe1                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe2                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
              dedupe3                    : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

            sed_E_command: 's/elapsed: [0-9\.]+/elapsed: <omitted>/'
  always:
    - name: delete tempdir
      file:
        path: "{{ tempdir.path }}"
        state: absent
      no_log: true
